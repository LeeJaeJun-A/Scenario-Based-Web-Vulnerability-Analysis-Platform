<script>
  import Navbar from "$lib/components/Navbar.svelte";
  import { onMount } from "svelte";
  import { writable } from "svelte/store";
  import { url, vul_list, scan_type } from "$lib/store";

  let vulStates = writable([]);

  function toggleVul(index) {
    vulStates.update((states) => {
      states[index] = !states[index];
      return states;
    });
  }

  // 취약점 강도 추가?
  const result = {
    "crawl_start": "2024/07/23 11:11:11",
    "crawl_end": "2024/07/23 11:30:11",
    "scan_start": "2024/07/23 11:11:11",
    "scan_end": "2024/07/23 11:50:11",
    "scan_result": [
      {
        "vul_type": "SQL Injection (주요통신기반시설)",
        "payloads": [
          {
            "payload": "' OR '1'='1",
            "public": "true",
            "url": "www.naver.com",
            "part": "<textarea></textarea>",
          },
          {
            "payload": "' OR '1'='112312312",
            "public": "true",
            "url": "https://section.blog.naver.com/BlogHome.naver?directoryNo=0&currentPage=1&groupId=0",
            "part": '<input ng-click="navigationCtrl.checkIsEmptyAndSendNclick($event)" ng-model="navigationCtrl.searchWord" bg-immediate-input="" bg-enter="navigationCtrl.search()" type="text" name="sectionBlogQuery" class="textbox ng-pristine ng-untouched ng-valid ng-empty ng-valid-maxlength" accesskey="" title="검색어를 입력하고 버튼을 누르세요" maxlength="255" autocomplete="off" value="" placeholder="">',
          },
        ],
        "tips": ["잘 좀 해라", "열심히 해"],
      },
      {
        "vul_type": "SQL_INJECTION_CVE",
        "payloads": [
          {
            "payload": "' OR '1'='112531253125",
            "public": "true",
            "url": "www.naver.com",
            "part": "<textarea>hihihi</textarea>",
          },
          {
            "payload": "' OR '1'='1235123513251",
            "public": "false",
            "url": "https://section.blog.naver.com/BlogHome.naver?directoryNo=0&currentPage=1&groupId=0",
            "part": '<input ng-click="navigationCtrl.checkIsEmptyAndSendNclick($event)" ng-model="navigationCtrl.searchWord" bg-immediate-input="" bg-enter="navigationCtrl.search()" type="text" name="sectionBlogQuery" class="textbox ng-pristine ng-untouched ng-valid ng-empty ng-valid-maxlength" accesskey="" title="검색어를 입력하고 버튼을 누르세요" maxlength="255" autocomplete="off" value="" placeholder="">',
          },
          {
            "payload": "' OR '1'='123513251235125321531",
            "public": "true",
            "url": "https://section.blog.naver.com/BlogHome.naver?directoryNo=0&currentPage=1&groupId=0",
            "part": '<input ng-click="navigationCtrl.checkIsEmptyAndSendNclick($event)" ng-model="navigationCtrl.searchWord" bg-immediate-input="" bg-enter="navigationCtrl.search()" type="text" name="sectionBlogQuery" class="textbox ng-pristine ng-untouched ng-valid ng-empty ng-valid-maxlength" accesskey="" title="검색어를 입력하고 버튼을 누르세요" maxlength="255" autocomplete="off" value="" placeholder="">',
          },
        ],
        "tips": ["할 수 있어"],
      },
    ],
  };

  onMount(() => {
    //result를 먼저 받아오고.
    vulStates.set(result.scan_result.map(() => false));
  });
</script>

<main>
  <Navbar />
  <div class="bg-customBlue flex flex-col items-center min-h-screen">
    <div
      id="summary"
      class="bg-customBlue flex flex-col justify-center items-center w-full"
      style="height: 60vh"
    >
      <div
        class="w-3/4 h-1/6 text-3xl text-white font-bold flex justify-start items-end p-2 min-[1920px]:text-5xl"
      >
        Summary
      </div>
      <hr class="border-t-2 border-white w-3/4 mb-4" />
      <div class="flex h-5/6 w-3/4 space-x-3">
        <div class="w-1/3 flex justify-center items-center">
          <div
            class="w-11/12 rounded-xl p-4 border border-customDeepBlue border-4"
            style="height: 90%"
          >
            <div class="text-white font-bold min-[1920px]:text-3xl">발견된 취약점 수</div>
            <div class="text-white py-2 text-4xl min-[1920px]:text-6xl">총 10개</div>
          </div>
        </div>
        <div class="w-1/3 flex justify-center items-center">
          <div
            class="w-11/12 rounded-xl p-4 border border-customDeepBlue border-4 space-y-1"
            style="height: 90%"
          >
            <div class="text-white font-bold min-[1920px]:text-3xl">검사 URL</div>
            <div class="text-white py-1 break-words text-sm min-[1920px]:text-2xl">{$url}</div>
            <div class="flex items-center space-x-2">
              <div class="text-white font-bold min-[1920px]:text-3xl">검사 타입:</div>
              <div class="text-white py-1 text-sm min-[1920px]:text-2xl">
                {#if $scan_type === "detail"}
                  정밀 검사
                {:else if $scan_type === "fast"}
                  빠른 검사
                {/if}
              </div>
            </div>
            <div class="text-white font-bold min-[1920px]:text-3xl">크롤링 시간</div>
            <div class="text-white text-sm min-[1920px]:text-2xl">
              {result.crawl_start} <br />~ {result.crawl_end}
            </div>
            <div class="text-white font-bold min-[1920px]:text-3xl">스캔 시간</div>
            <div class="text-white text-sm min-[1920px]:text-2xl">
              {result.scan_start} <br />~ {result.scan_end}
            </div>
          </div>
        </div>
        <div class="w-1/3 flex justify-center items-center">
          <div
            class="w-11/12 rounded-xl p-4 border border-customDeepBlue border-4"
            style="height: 90%"
          >
            <div class="text-white font-bold min-[1920px]:text-3xl">검사한 취약점 목록</div>
            <div class="text-white overflow-auto text-sm h-5/6 min-[1920px]:text-2xl py-1">
              {#each $vul_list as vul}
                <p>{vul}</p>
              {/each}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      class="w-full bg-customBlue flex flex-col justify-center items-center"
      style="height: 15vh;"
    >
      <div class="w-3/4 h-full">
        <div
          class="h-3/4 w-full text-3xl flex justify-start items-end mb-2 text-white font-bold min-[1920px]:text-5xl"
        >
          Vulnearabiltiy
        </div>
        <hr class="border-t-2" />
      </div>
    </div>
    <div
      id="detail_result"
      class="bg-customBlue w-full flex flex-col justify-center items-center"
    >
      {#if result.scan_result.length == 0}
        <div
          class="w-3/4 flex items-center justify-center text-white text-lg"
          style="height: 6vh;"
        >
          No vulnerabilities found
        </div>
      {:else}
        <div class="w-3/4 space-y-4">
          {#each result.scan_result as vul, index}
            <div class="w-full h-full">
              <button
                class="text-white text-xl w-full text-left font-bold min-[1920px]:text-3xl"
                on:click={() => toggleVul(index)}
              >
                {vul.vul_type}
              </button>
              <hr class="border-t-1" />
              {#if $vulStates[index]}
                {#if vul.payloads.length > 0}
                  {#each vul.payloads as payload}
                    <div class="flex flex-col p-2 min-[1920px]:text-2xl">
                      <div class="text-white font-bold">Payload</div>
                      {#if payload.public === "true"}
                        <div class="text-gray-300">{payload.payload}</div>
                      {:else}
                        <div class="text-gray-300">비공개 페이로드</div>
                      {/if}
                      <div class="text-white font-bold">URL</div>
                      <div class="text-gray-300">{payload.url}</div>
                      <div class="text-white font-bold">Part</div>
                      <div class="text-gray-300">{payload.part}</div>
                    </div>
                  {/each}
                  <div class="flex flex-col p-2 min-[1920px]:text-2xl">
                    <div class="text-white font-bold">Tips</div>
                    {#if vul.tips.length > 0}
                      {#each vul.tips as tip}
                        <p class="text-gray-300">{tip}</p>
                      {/each}
                    {:else}
                      <p>해당 취약점에 대한 팁이 존재하지 않습니다.</p>
                    {/if}
                  </div>
                {/if}
              {/if}
            </div>
          {/each}
        </div>
      {/if}
    </div>
    <div
      id="download"
      class="flex justify-center items-center bg-customBlue w-full"
      style="height: 20vh"
    >
      <!--취약점이 없어도 필요한가?-->
      <div class="w-3/4 h-full space-x-2 flex justify-end items-center p-2">
        <div
          class="flex items-center h-1/3 justify-center text-xl font-bold text-white min-[1920px]:text-4xl"
          style="width: 15%"
        >
          Download as
        </div>
        <button class="bg-white h-1/3 w-1/6 rounded-full hover:scale-105 min-[1920px]:text-3xl"
          >CSV</button
        >
        <button class="bg-white h-1/3 w-1/6 rounded-full hover:scale-105 min-[1920px]:text-3xl"
          >DOC</button
        >
      </div>
    </div>
  </div>
</main>
