<script>
  import { vulnerabilities_name, vul_list, scan_type } from "$lib/store";
  import Navbar from "$lib/components/Navbar.svelte";
  import { writable } from "svelte/store";
  import { goto } from "$app/navigation";

  let vulStatus = [];
  const showWarning = writable(false);

  let selectedOptions = {
    jutongi: false,
    owasp: false,
    cve: false,
  };

  let vulnerabilities = {
    ADMINISTRATOR_PAGE_EXPOSURE: false,
    AUTOMATED_ATTACK_VULNERABILITIES: false,
    BUFFER_OVERFLOW: false,
    COOKIE_MODIFICATION: false,
    CSRF_JUTONGI: false,
    DIRECTORY_TRAVERSAL: false,
    FORMAT_STRING: false,
    INSUFFICIENT_AUTHENTICATION: false,
    INSUFFICIENT_AUTHORIZATION: false,
    INSUFFICIENT_SESSION_EXPIRATION: false,
    LDAP_INJECTION: false,
    LOCATION_DISCLOSURE: false,
    MALICIOUS_CONTENT: false,
    MISSING_PROCESS_VALIDATION: false,
    PLAIN_TEXT_TRANSFER: false,
    ROUTE_TRACKING: false,
    RUN_OS_COMMAND: false,
    SESSION_FIXATION: false,
    SESSION_PREDICTION: false,
    SQL_INJECTION_JUTONGI: false,
    SSI_INJECTION: false,
    SSRF_JUTONGI: false,
    WEAK_STRING_STRENGTH: false,
    XPATH_INJECTION: false,
    XSS_JUTONGI: false,
    SSRF_OWASP: false,
    IDENTIFICATION_AUTHENTICATION_FAILURE: false,
    SQL_INJECTION_OWASP: false,
    XSS_OWASP: false,
    SQL_INJECTION_CVE: false,
    XSS_CVE: false,
    CSRF_CVE: false,
    SSRF_CVE: false,
    XXE_INJECTION: false,
  };

  const optionVulnerabilities = {
    jutongi: [
      "ADMINISTRATOR_PAGE_EXPOSURE",
      "AUTOMATED_ATTACK_VULNERABILITIES",
      "BUFFER_OVERFLOW",
      "COOKIE_MODIFICATION",
      "CSRF_JUTONGI",
      "DIRECTORY_TRAVERSAL",
      "FORMAT_STRING",
      "INSUFFICIENT_AUTHENTICATION",
      "INSUFFICIENT_AUTHORIZATION",
      "INSUFFICIENT_SESSION_EXPIRATION",
      "LDAP_INJECTION",
      "LOCATION_DISCLOSURE",
      "MALICIOUS_CONTENT",
      "MISSING_PROCESS_VALIDATION",
      "PLAIN_TEXT_TRANSFER",
      "ROUTE_TRACKING",
      "RUN_OS_COMMAND",
      "SESSION_FIXATION",
      "SESSION_PREDICTION",
      "SQL_INJECTION_JUTONGI",
      "SSI_INJECTION",
      "SSRF_JUTONGI",
      "WEAK_STRING_STRENGTH",
      "XPATH_INJECTION",
      "XSS_JUTONGI",
    ],
    owasp: [
      "SSRF_OWASP",
      "IDENTIFICATION_AUTHENTICATION_FAILURE",
      "SQL_INJECTION_OWASP",
      "XSS_OWASP",
    ],
    cve: [
      "SQL_INJECTION_CVE",
      "DIRECTORY_TRAVERSAL",
      "XSS_CVE",
      "CSRF_CVE",
      "SSRF_CVE",
      "XXE_INJECTION",
    ],
  };

  function toggleScenario(option) {
    selectedOptions[option] = !selectedOptions[option];

    optionVulnerabilities[option].forEach((vul) => {
      vulnerabilities[vul] = selectedOptions[option];
    });
  }

  function toggleVulnerability(key) {
    vulnerabilities[key] = !vulnerabilities[key];
  }

  function handleScan(type) {
    vulStatus = Object.keys(vulnerabilities).filter(
      (key) => vulnerabilities[key]
    );
    if (vulStatus.length === 0) {
      showWarning.set(true);
      setTimeout(() => {
        showWarning.set(false);
      }, 3000);
    } else {
      vul_list.set(vulStatus);
      scan_type.set(type);
      goto("/scan");
    }
  }
</script>

<main class="flex flex-col items-center h-screen bg-customBlue">
  <Navbar />
  <div class="w-5/6 h-full relative">
    <h1
      class="text-3xl text-white font-bold flex justify-center items-end w-full min-[1920px]:text-6xl"
      style="height: 8%;"
    >
      취약점 선택
    </h1>
    <div
      class="flex space-x-4 w-full justify-center items-center"
      style="height: 8%;"
    >
      <button
        class="bg-gray-100 rounded-full w-1/6 h-2/3 min-[1920px]:text-2xl hover:scale-105"
        class:bg-slate-500={selectedOptions["jutongi"]}
        class:text-white={selectedOptions["jutongi"]}
        on:click={() => toggleScenario("jutongi")}>주요통신기반시설</button
      >
      <button
        class="bg-gray-100 rounded-full w-1/6 h-2/3 min-[1920px]:text-2xl hover:scale-105"
        class:bg-slate-500={selectedOptions["owasp"]}
        class:text-white={selectedOptions["owasp"]}
        on:click={() => toggleScenario("owasp")}>OWASP</button
      >
      <button
        class="bg-gray-100 rounded-full w-1/6 h-2/3 min-[1920px]:text-2xl hover:scale-105"
        class:bg-slate-500={selectedOptions["cve"]}
        class:text-white={selectedOptions["cve"]}
        on:click={() => toggleScenario("cve")}>CVE</button
      >
    </div>
    <div class="h-2/3 p-4 overflow-y-auto w-full min-[1920px]:text-2xl">
      {#each Array(Math.ceil(Object.keys(vulnerabilities).length / 5)) as _, rowIndex}
        <div class="flex h-1/5 w-full">
          {#each Object.keys(vulnerabilities).slice(rowIndex * 5, rowIndex * 5 + 5) as key, index}
            <button
              class="bg-gray-200 text-black p-1 rounded flex items-center justify-center m-2 w-1/5 hover:scale-105"
              class:bg-gray-400={vulnerabilities[key]}
              on:click={() => toggleVulnerability(key)}
            >
              {@html vulnerabilities_name[key]}
            </button>
          {/each}
          {#if Object.keys(vulnerabilities).slice(rowIndex * 5, rowIndex * 5 + 5).length < 5}
            {#each Array(5 - Object.keys(vulnerabilities).slice(rowIndex * 5, rowIndex * 5 + 5).length) as _}
              <div class="m-2 w-1/5"></div>
            {/each}
          {/if}
        </div>
      {/each}
    </div>
    <div class="relative flex flex-col items-center h-1/6 justify-center">
      {#if $showWarning}
        <div
          class="absolute top-1 left-1/2 transform -translate-x-1/2 text-red-500 text-sm py-1 rounded min-[1920px]:text-2xl min-[1920px]:top-4"
        >
          취약점을 한 개 이상 선택해주세요
        </div>
      {/if}
      <div class="flex space-x-4 w-full h-2/3 justify-center items-center min-[1920px]:text-2xl">
        <button
          class="bg-customDeepBlue text-white rounded-full h-1/2 w-1/6 hover:scale-105"
          on:click={() => handleScan("fast")}>빠른 검사</button
        >
        <button
          class="bg-customDeepBlue text-white rounded-full h-1/2 w-1/6 hover:scale-105"
          on:click={() => handleScan("detail")}>정밀 검사</button
        >
      </div>
    </div>
  </div>
</main>
