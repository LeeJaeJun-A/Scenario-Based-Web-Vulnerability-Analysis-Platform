<script>
  import { url, vul_list, scan_type, resetState } from "$lib/store";
  import { writable } from "svelte/store";
  import { goto } from "$app/navigation";
  import { onMount, onDestroy } from "svelte";

  let progress = writable(0);
  let waitingList = writable([]);
  let completedList = writable([]);
  let showModal = writable(false);
  let text = 'Scanning...';
  let displayedText = "";
  let index = 0;

  function cancelScan() {
    //   if (socket) {
    //     socket.close();
    //   }
    resetState();
    goto("/");
  }

  function updateText() {
    displayedText = text.slice(0, index + 1);
    index = (index + 1) % (text.length + 1);
  }

  function toggleModal() {
    showModal.update((n) => !n);
  }
  // Socket 열고 넣기
  // progress.set((completedList.length / (vul_list.length + 2) * 100));
  // 검사 끝나면 자동으로 RESULT 페이지로 넘어가도록
  onMount(() => {
    const intervalId = setInterval(updateText, 200);
    waitingList.set($vul_list);
  });

  onDestroy(() => {
    clearInterval(intervalId); // 컴포넌트가 언마운트될 때 인터벌 정리
  });
</script>

<main
  class="h-screen bg-customBlue flex flex-col justify-center items-center relative"
>
  <div
    class="w-5/6 flex flex-col justify-center items-center"
    style="height: 90%"
  >
    <div class="flex justify-center items-center w-full" style="height: 10%">
      <div
        class="w-11/12 flex items-center bg-gray-200 rounded-full h-1/2 shadow-lg"
      >
        {#if $progress > 0}
          <div
            class="bg-blue-700 font-medium text-blue-100 h-full flex justify-center items-center leading-none rounded-full min-[1920px]:text-3xl shadow-inner"
            style="width: {$progress}%"
          >
            {Math.round($progress)}%
          </div>
        {:else}
          <div
            class="w-full h-full flex items-center justify-center pl-3 min-[1920px]:text-3xl min-[1920px]:pl-5"
          >
            <span class="inline-block whitespace-nowrap overflow-hidden flex items-center justify-center"
              >{displayedText}</span
            >
          </div>
        {/if}
      </div>
    </div>
    <div class="flex w-11/12" style="height: 80%;">
      <div class="h-full w-1/2 flex flex-col justify-center">
        <span
          class="w-11/12 flex bg-customDeepBlue justify-center rounded-t-lg items-center text-white min-[1920px]:text-4xl shadow-md"
          style="height: 7%">스캔 대기 중 취약점</span
        >
        <div
          class="flex flex-col h-5/6 w-11/12 p-2 bg-gray-200 rounded-b-lg min-[1920px]:text-3xl shadow-lg overflow-auto"
        >
          {#if $waitingList.length > 0}
            {#each $waitingList as waitingVul}
              <p>{waitingVul}</p>
            {/each}
          {/if}
        </div>
      </div>
      <div class="h-full w-1/2 flex flex-col justify-center items-end">
        <span
          class="w-11/12 flex bg-customDeepBlue justify-center rounded-t-lg items-center text-white min-[1920px]:text-3xl shadow-md"
          style="height: 7%">스캔 완료 취약점</span
        >
        <div
          class="flex flex-col h-5/6 w-11/12 p-2 bg-gray-200 rounded-b-lg min-[1920px]:text-3xl shadow-lg overflow-auto"
        >
          {#if $completedList.length > 0}
            {#each $completedList as completedVul}
              <p>{completedVul}</p>
            {/each}
          {/if}
        </div>
      </div>
    </div>
    <div class="w-full flex justify-center items-center" style="height: 10%">
      <button
        class="bg-gray-100 h-1/2 w-1/12 rounded-lg min-[1920px]:text-2xl hover:scale-105 shadow-md"
        on:click={toggleModal}>검사 취소</button
      >
    </div>
  </div>

  {#if $showModal}
    <div
      class="absolute top-0 left-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg text-center relative z-50">
        <p class="min-[1920px]:text-2xl mb-4">
          정말 검사를 종료하시겠습니까?<br />현재까지 진행한 검사 내역이 모두
          지워집니다.
        </p>
        <div class="flex justify-center space-x-4">
          <button
            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700"
            on:click={cancelScan}>확인</button
          >
          <button
            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700"
            on:click={toggleModal}>취소</button
          >
        </div>
      </div>
    </div>
  {/if}
  <!-- 추후 삭제-->
  <button class="bg-gray-500" on:click={() => goto("/result")}
    >결과 페이지 보기</button
  >
  <!---->
</main>
